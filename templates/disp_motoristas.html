{% extends "base.html" %}
{% block content %}
<h1>Disponibilidade • Motoristas</h1>
<p><b>Data de operação:</b> {{ data_ref.strftime("%d/%m/%Y") }}</p>

<form method="post" action="{{ url_for('disp_motoristas_salvar') }}">
  <input type="hidden" name="data_operacao" value="{{ data_ref.isoformat() }}">

  <table>
    <thead>
      <tr>
        <th>Disponível</th><th>Base</th><th>Motorista</th><th>Status (se não disponível)</th><th>Período</th><th>Obs</th>
      </tr>
    </thead>
    <tbody>
      {% for m in motoristas %}
        {% set r = regs_map.get(m.id) %}
        {% set is_disp = (r is none) or (r.status == "Disponível") %}
        <tr>
          <td>
            <input type="hidden" name="motorista_id" value="{{ m.id }}">
            <input type="checkbox" name="disponivel" value="{{ m.id }}" class="chk-disp" {% if is_disp %}checked{% endif %}>
          </td>
          <td>{{ m.base }}</td>
          <td>{{ m.nome }}</td>
          <td>
            <select name="status" class="sel-status">
              {% set val = (r.status if r else "Falta") %}
              {% for s in ["Folga","Férias","Atestado","Falta","Restrição"] %}
                <option {% if s==val %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select name="periodo">
              {% set p = (r.periodo if r and r.periodo else "Integral") %}
              {% for s in ["Integral","Manhã","Tarde"] %}
                <option {% if s==p %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input name="obs" value="{{ r.obs if r and r.obs else '' }}" placeholder="Observações"></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit">Salvar</button>
</form>

<script>
  function refreshRow(row){
    const chk = row.querySelector('.chk-disp');
    const sel = row.querySelector('.sel-status');
    if(chk.checked){
      sel.disabled = true;
      sel.style.opacity = 0.5;
    } else {
      sel.disabled = false;
      sel.style.opacity = 1;
    }
  }
  document.querySelectorAll('tr').forEach(tr => {
    const chk = tr.querySelector('.chk-disp');
    if(!chk) return;
    refreshRow(tr);
    chk.addEventListener('change', () => refreshRow(tr));
  });
</script>
{% endblock %}
