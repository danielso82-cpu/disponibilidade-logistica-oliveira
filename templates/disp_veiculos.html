{% extends "base.html" %}
{% block content %}
<h1>Disponibilidade • Veículos</h1>
<p><b>Data de operação:</b> {{ data_ref.strftime("%d/%m/%Y") }}</p>

<form method="post" action="{{ url_for('disp_veiculos_salvar') }}">
  <input type="hidden" name="data_operacao" value="{{ data_ref.isoformat() }}">

  <table>
    <thead>
      <tr>
        <th>Disponível</th><th>Base</th><th>Tipo</th><th>Placa</th><th>Modelo</th>
        <th>Status (se não disponível)</th><th>Liberação</th><th>Obs</th>
      </tr>
    </thead>
    <tbody>
      {% for v in veiculos %}
        {% set r = regs_map.get(v.id) %}
        {% set is_disp = (r is none) or (r.status == "Disponível") %}
        <tr>
          <td>
            <input type="hidden" name="veiculo_id" value="{{ v.id }}">
            <input type="checkbox" name="disponivel_veic" value="{{ v.id }}" class="chk-disp" {% if is_disp %}checked{% endif %}>
          </td>
          <td>{{ v.base }}</td>
          <td>{{ v.tipo_rodado }}</td>
          <td>{{ v.placa }}</td>
          <td>{{ v.modelo or "" }}</td>

          <td>
            <select name="status" class="sel-status">
              {% set val = (r.status if r else "Manutenção") %}
              {% for s in ["Manutenção","Quebrado","Documento","Uso Parcial"] %}
                <option {% if s==val %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input name="previsao_liberacao" value="{{ r.previsao_liberacao if r and r.previsao_liberacao else '' }}" placeholder="Ex: 10:00"></td>
          <td><input name="obs" value="{{ r.obs if r and r.obs else '' }}" placeholder="Observações"></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit">Salvar</button>
</form>

<script>
  function refreshRow(row){
    const chk = row.querySelector('.chk-disp');
    const sel = row.querySelector('.sel-status');
    if(chk.checked){
      sel.disabled = true;
      sel.style.opacity = 0.5;
    } else {
      sel.disabled = false;
      sel.style.opacity = 1;
    }
  }
  document.querySelectorAll('tr').forEach(tr => {
    const chk = tr.querySelector('.chk-disp');
    if(!chk) return;
    refreshRow(tr);
    chk.addEventListener('change', () => refreshRow(tr));
  });
</script>
{% endblock %}
